// Generated by MyGeneration Version # (1.3.0.9)
using System;
using System.Collections.Generic;
using System.Data;
using System.Text;
using LD.SPPipeManage.Bussiness.Wrappers;
using LD.SPPipeManage.Entity.CustomTyoe;
using LD.SPPipeManage.Entity.Tables;
using Spring.Data.Common;

namespace LD.SPPipeManage.Data.AdoNet
{











    public partial class AdoNetDataObject
    {
        #region Common

        private T GetScalarFromDataSet<T>(DataTable dt, int columnIndex)
        {
            DataRow dr = GetFristDataRowFromDataTable(dt);

            if (dr != null && dr.Table.Columns.Count >= columnIndex + 1)
                return (T)dr[columnIndex];
            return default(T);
        }

        private T GetScalarFromDataSet<T>(DataSet ds, int columnIndex)
        {
            return GetScalarFromDataSet<T>(GetDataTableFromDataSet(ds), columnIndex);
        }

        private DataRow GetFristDataRowFromDataSet(DataSet ds)
        {
            return GetFristDataRowFromDataTable(GetDataTableFromDataSet(ds));
        }

        private DataRow GetFristDataRowFromDataTable(DataTable dt)
        {
            if (dt != null && dt.Rows.Count > 0)
                return dt.Rows[0];
            return null;
        }

        private DataTable GetDataTableFromDataSet(DataSet ds)
        {
            if (ds != null && ds.Tables.Count > 0)
                return ds.Tables[0];
            return null;
        }

        #endregion


        public string BuildSelectPageSql(string selectField, string tableName, string where, string orderBy, int pageIndex, int pageSize)
        {
            StringBuilder sb = new StringBuilder();

            StringBuilder subquery = new StringBuilder();

            subquery.AppendFormat("SELECT {0},ROW_NUMBER() OVER({1}) AS RowNumber FROM {2} {3} ", selectField, orderBy,
                                  tableName, where);

            int startIndex = (pageIndex - 1) * pageSize + 1;


            sb.AppendFormat(
                "SELECT {0},RowNumber FROM ({1}) AS RowNumberTableSource WHERE  RowNumber BETWEEN {2} AND {3} ", selectField, subquery.ToString(), startIndex, pageIndex * pageSize);


            return sb.ToString();
        }


        public string BuildCountPageSql(string tableName, string where)
        {
            StringBuilder sb = new StringBuilder();

            sb.AppendFormat(" SELECT COUNT(*) FROM {0} {1} ", tableName, where);

            return sb.ToString();
        }


        public DataTable ExcutePageResult(string selectField, string tableName, string where, string orderBy, int pageIndex, int pageSize)
        {
            string sql = BuildSelectPageSql(selectField, tableName, where, orderBy, pageIndex, pageSize);

            return this.ExecuteDataSet(sql, CommandType.Text, this.CreateNewDbParameters()).Tables[0];

        }


        public int ExcuteCount(string tableName, string where)
        {
            string sql = BuildCountPageSql(tableName, where);

            object result = this.ExecuteScalar(sql, CommandType.Text, this.CreateNewDbParameters());

            if (result == System.DBNull.Value)
                return 0;

            return (int)result;
        }

        public DataSet GetAllNOReportData(int year, int month, int day)
        {
            string sql = "Select * from wiew_NoPayReport where CYear = @year and  CMonth =  @month and  CDay=@day";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", year.ToString());

            dbParameters.AddWithValue("month", month.ToString());

            dbParameters.AddWithValue("day", day.ToString());

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }

        public void ClearAllReportedData(DateTime date)
        {
            string sql = "update SPPaymentInfo set  IsReport = 1  where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and  IsReport = 0";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }


        public void ResetAllReportedData(DateTime date)
        {
            string sql = "update SPPaymentInfo set  IsReport = 0  where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and  (IsReport = 1 or IsReport is null)";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }






        public DataSet GetAllClientChannel()
        {
            string sql = "select ChannelID,ClinetID as ClientID from dbo.SPClientChannelSetting group by ChannelID,ClinetID";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }


        public string GetDbSize()
        {
            string sql = "exec sp_spaceused";

            DbParameters dbParameters = this.CreateNewDbParameters();

            DataSet ds = this.ExecuteDataSet(sql, CommandType.Text, dbParameters);

            return ds.Tables[0].Rows[0]["database_size"].ToString();
        }


        public void DeleteAllReportData(DateTime date)
        {
            string sql = "delete from SPPaymentInfo where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and IsReport = 1";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }


        public DataSet GetAllNeedSendChannelClient()
        {
            string sql = "SELECT  [ChannelID],[ClinetID] FROM  [dbo].[SPClientChannelSetting] where [SyncData] = 1 group by [ChannelID],[ClinetID]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }


        public DataSet GetAllReportData(DateTime date)
        {
            string sql = "Select * from SPPaymentInfo where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and IsReport = 1";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }

        public DataTable GetDayliyReport(DateTime date)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ChannelID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ClientID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));


            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dsDaySumReport = GetDaySumReport(date.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                j++;

                ReportResult reportResult = GetTodayReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], dsDaySumReport);

                reportDt.Rows.Add(j,
                                  rowChannelClient["ChannelName"],
                                  rowChannelClient["ClientName"],
                                  reportResult.TotalCount,
                                  reportResult.DownCount,
                                  reportResult.InterceptCount,
                                  reportResult.DownSycnCount,
                                  reportResult.InterceptRate,
                                  (int)rowChannelClient["ChannelID"],
                                  (int)rowChannelClient["ClientID"],
                                  date);
            }

            return reportDt;
        }

        private ReportResult GetTodayReportResult(int clientId, int channelId, DataTable dsDaySumReport)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ClientID = {0} and ChannelID = {1} ", clientId, channelId);

            DataRow[] drs = dsDaySumReport.Select(filterSql);

            reportResult.TotalCount = ExecuteScalarFormDataRowArray("UpTotalCount", drs);
            reportResult.DownCount = ExecuteScalarFormDataRowArray("DownTotalCount", drs);
            reportResult.InterceptCount = ExecuteScalarFormDataRowArray("InterceptTotalCount", drs);
            reportResult.DownSycnCount = ExecuteScalarFormDataRowArray("DownSuccess", drs);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }

        public int ExecuteScalarFormDataRowArray(string field, DataRow[] drs)
        {
            if (drs.Length <= 0)
                return 0;

            if (drs[0][field] == System.DBNull.Value)
                return 0;

            return (int)drs[0][field];
        }

        private DataTable GetDaySumReport(DateTime date)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where Year = @year and  Month =  @month and  Day=@day";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetTodayReport(int clientId, int channelId)
        {
            string sql = "";

            if (channelId != 0)
            {
                sql = "SELECT ClientID, ChannelID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord Where (ChannelID = @ChannelID) AND (ClientID = @ClientID) GROUP BY ClientID, ChannelID, CHour  ";
            }
            else
            {
                sql = "SELECT ClientID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord where ClientID =  @ClientID GROUP BY ClientID, ChannelID, CHour   ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ClientID", clientId);

            if (channelId != 0)
            {
                dbParameters.AddWithValue("ChannelID", channelId);
            }

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }



        public DataTable GetDayliyReport(int channelId, int clientId, DateTime startDateTime, DateTime enddateTime)
        {

            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("RID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("Price", typeof(decimal)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForMaster(channelId, clientId, startDateTime.Date, enddateTime.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                if (channelId > 0)
                {
                    if ((int)rowChannelClient["ChannelID"] != channelId)
                        continue;
                }
                if (clientId > 0)
                {
                    if ((int)rowChannelClient["ClientID"] != clientId)
                        continue;
                }

                for (DateTime i = startDateTime; i < enddateTime.AddDays(1); i = i.AddDays(1))
                {
                    j++;

                    ReportResult reportResult = GetReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], i, dCountReportForMaster);

                    reportDt.Rows.Add(j, i.Date,
                                      rowChannelClient["ChannelName"],
                                      reportResult.DownCount,
                                      reportResult.DownSycnCount, decimal.Zero);
                }
            }

            return reportDt;













            //int j = 0;

            //for (DateTime i = startDateTime; i < enddateTime.AddDays(1); i = i.AddDays(1))
            //{
            //    string sql = "";

            //    if (channelId != 0)
            //    {
            //        sql = "SELECT  ClientID,ChannelID,Sum(UpTotalCount) as TotalCount,Sum(InterceptSuccess) as InterceptCount,Sum(DownSuccess) as DownTotal FROM [dbo].[view_ReportDayTotal] where Year = @year and  Month =  @month and  Day=@day and ClientID = @ClientID and ChannelID=@ChannelID group by  ClientID,ChannelID";
            //    }
            //    else
            //    {
            //        sql = "SELECT  ClientID,Sum(UpTotalCount) as TotalCount,Sum(InterceptSuccess) as InterceptCount,Sum(DownSuccess) as DownTotal FROM [dbo].[view_ReportDayTotal] where Year = @year and  Month =  @month and  Day=@day and ClientID = @ClientID group by  ClientID";
            //    }

            //    DbParameters dbParameters = this.CreateNewDbParameters();

            //    dbParameters.AddWithValue("year", i.Year);

            //    dbParameters.AddWithValue("month", i.Month);

            //    dbParameters.AddWithValue("day", i.Day);

            //    dbParameters.AddWithValue("ClientID", clientId);

            //    if (channelId != 0)
            //    {
            //        dbParameters.AddWithValue("ChannelID", channelId);
            //    }

            //    DataTable dt = this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];

            //    j++;

            //    if(dt==null|| dt.Rows.Count==0)
            //    {
            //        reportDt.Rows.Add(j,i, 0, 0);
            //    }
            //    else
            //    {
            //        reportDt.Rows.Add(j, i, dt.Rows[0]["DownTotal"], 0);      
            //    }
            //}

            return reportDt;
        }

        public ReportResult GetDayReportResult(int clientID, int channelID, DataTable dsDayTotalCount, DataTable dsDayDownCount, DataTable dsDayInterceptCount, DataTable dsDayDownSycnCount)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ClientID = {0} and ChannelID = {1} ", clientID, channelID);

            reportResult.TotalCount = ExecuteScalarFormDataTable("TotalCount", filterSql, dsDayTotalCount);
            reportResult.DownCount = ExecuteScalarFormDataTable("DownCount", filterSql, dsDayDownCount);
            reportResult.InterceptCount = ExecuteScalarFormDataTable("InterceptCount", filterSql, dsDayInterceptCount);
            reportResult.DownSycnCount = ExecuteScalarFormDataTable("DownSycnCount", filterSql, dsDayDownSycnCount);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }


        public DataTable GetDayTotalCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllTotalCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetDayDownCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllDownCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetDayInterceptCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllInterceptCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetDayDownSycnCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllDownSycnCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }





        #region TodayReport

        public DataTable GetAllTodayReport(bool filterZeroCountChannel)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ChannelClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ChannelID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ClientID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ChannelClientID", typeof(int)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = null;

            if (filterZeroCountChannel)
                dtChannelClient = GetAllTodayChannelClient();
            else
                dtChannelClient = GetAllChannelClient();

            int j = 0;

            DataTable dsTodayTotalCount = GetTodayTotalCount();
            DataTable dsTodayDownCount = GetTodayDownCount();
            DataTable dsTodayInterceptCount = GetTodayInterceptCount();
            DataTable dsTodayDownSycnCount = GetTodayDownSycnCount();

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                j++;

                ReportResult reportResult = GetTodayReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], dsTodayTotalCount, dsTodayDownCount, dsTodayInterceptCount, dsTodayDownSycnCount);

                reportDt.Rows.Add(j, System.DateTime.Now.Date,
                                  rowChannelClient["ChannelName"],
                                  rowChannelClient["ClientName"],
                                  rowChannelClient["ChannelName"] + " - " + rowChannelClient["ClientName"],
                                  reportResult.TotalCount,
                                  reportResult.DownCount,
                                  reportResult.InterceptCount,
                                  reportResult.DownSycnCount,
                                  reportResult.InterceptRate,
                                  (int)rowChannelClient["ChannelID"],
                                  (int)rowChannelClient["ClientID"], System.DBNull.Value);
            }

            return reportDt;
        }

        private ReportResult GetTodayReportResult(int clientID, int channelID, DataTable dsTodayTotalCount, DataTable dsTodayDownCount, DataTable dsTodayInterceptCount, DataTable dsTodayDownSycnCount)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ClientID = {0} and ChannelID = {1} ", clientID, channelID);

            reportResult.TotalCount = ExecuteScalarFormDataTable("TotalCount", filterSql, dsTodayTotalCount);
            reportResult.DownCount = ExecuteScalarFormDataTable("DownCount", filterSql, dsTodayDownCount);
            reportResult.InterceptCount = ExecuteScalarFormDataTable("InterceptCount", filterSql, dsTodayInterceptCount);
            reportResult.DownSycnCount = ExecuteScalarFormDataTable("DownSycnCount", filterSql, dsTodayDownSycnCount);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }

        private DataTable GetTodayTotalCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayTotalCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        private DataTable GetTodayDownCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayDownCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        private DataTable GetTodayInterceptCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayInterceptCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        private DataTable GetTodayDownSycnCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayDownSycnCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        #endregion



        public DataTable GetAllChannelClient()
        {
            string sql = "SELECT * FROM [view_AllClientChannel]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataTable GetAllTodayChannelClient()
        {
            string sql = @"SELECT * FROM [view_AllTodayClientChannleInfo]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }













        public DataTable GetAllEnableChannelClient()
        {
            string sql = "SELECT * FROM [view_PaymentReportClientChannel]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }



        public decimal CountInterceptRate(int clientID, int channelID)
        {
            string procName = "CountInterceptRate";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ClientID", clientID);

            dbParameters.AddWithValue("ChannelID", channelID);

            dbParameters.AddReturn("returnvalue", DbType.Int32);


            int interceptRate = 0;

            this.ExecuteNoQuery(procName, CommandType.StoredProcedure, dbParameters);

            object result = dbParameters["@returnvalue"].Value;

            if (result != System.DBNull.Value)
            {
                interceptRate = (int)result;
            }

            return Convert.ToDecimal(interceptRate) / 100;
        }


        public int ExecuteScalarFormDataTable(string scalarField, string filterExpress, DataTable dt)
        {
            DataRow[] selectDrs = dt.Select(filterExpress);

            if (selectDrs.Length > 0)
            {
                object result = selectDrs[0][scalarField];

                if (result == System.DBNull.Value)
                {
                    return 0;
                }
                else
                {
                    return (int)result;
                }
            }

            return 0;
        }


        public DataTable GetCountReportForMaster(int channelId, int clientId, DateTime startDateTime, DateTime enddateTime)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForMaster(channelId, clientId, startDateTime.Date, enddateTime.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                if (channelId > 0)
                {
                    if ((int)rowChannelClient["ChannelID"] != channelId)
                        continue;
                }
                if (clientId > 0)
                {
                    if ((int)rowChannelClient["ClientID"] != clientId)
                        continue;
                }

                for (DateTime i = startDateTime; i < enddateTime.AddDays(1); i = i.AddDays(1))
                {
                    j++;

                    ReportResult reportResult = GetReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], i, dCountReportForMaster);

                    reportDt.Rows.Add(j,
                                      rowChannelClient["ChannelName"],
                                      rowChannelClient["ClientName"],
                                      reportResult.TotalCount,
                                      reportResult.DownCount,
                                      reportResult.InterceptCount,
                                      reportResult.DownSycnCount,
                                      reportResult.InterceptRate, i.Date);
                }
            }

            return reportDt;
        }

        public DataTable GetCountReportForMaster(int channelId, DateTime startDateTime, DateTime enddateTime)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForMaster(channelId, 0, startDateTime.Date, enddateTime.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                if (channelId > 0)
                {
                    if ((int)rowChannelClient["ChannelID"] != channelId)
                        continue;
                }


                for (DateTime i = enddateTime.Date; i > startDateTime.AddDays(-1); i = i.AddDays(-1))
                {
                    j++;

                    ReportResult reportResult = GetReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], i, dCountReportForMaster);

                    reportDt.Rows.Add(j,
                                      rowChannelClient["ChannelName"],
                                      rowChannelClient["ClientName"],
                                      reportResult.TotalCount,
                                      reportResult.DownCount,
                                      reportResult.InterceptCount,
                                      reportResult.DownSycnCount,
                                      reportResult.InterceptRate, i.Date);
                }
            }

            return reportDt;
        }

        private ReportResult GetReportResult(int clientID, int channelID, DateTime dateTime, DataTable dCountReportForMaster)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ReportDate='{0}' ", dateTime);

            if (channelID > 0)
            {
                filterSql += string.Format(" And  channelId = {0} ", channelID);
            }

            if (clientID > 0)
            {
                filterSql += string.Format(" And  clientID = {0} ", clientID);
            }

            reportResult.TotalCount = ExecuteSumFormDataTable("UpTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownCount = ExecuteSumFormDataTable("DownTotalCount", filterSql, dCountReportForMaster);
            reportResult.InterceptCount = ExecuteSumFormDataTable("InterceptTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownSycnCount = ExecuteSumFormDataTable("DownSuccess", filterSql, dCountReportForMaster);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }

        private int ExecuteSumFormDataTable(string field, string filterSql, DataTable dCountReportForMaster)
        {
            object result = dCountReportForMaster.Compute(string.Format(" SUM({0}) ", field), filterSql);

            if (result == System.DBNull.Value)
            {
                return 0;
            }
            else
            {
                return Convert.ToInt32(result);
            }

            return 0;
        }

        private DataTable QueryReportForMaster(int channelId, int clientID, DateTime startDateTime, DateTime enddateTime)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where ReportDate>=@startDate and ReportDate<=@enddate ";

            if (channelId > 0)
            {
                sql += " And  channelId = @channelId ";
            }

            if (clientID > 0)
            {
                sql += " And  clientID = @clientID ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            if (channelId > 0)
            {
                dbParameters.AddWithValue("channelId", channelId);
            }

            if (clientID > 0)
            {
                dbParameters.AddWithValue("clientID", clientID);
            }

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetTodayReportByClientGroupID(int clientGroupID)
        {
            string sql = "";

            sql = "SELECT ClientID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord where ClientID in (SELECT  [ID] FROM  [SPClient] where [SPClientGroupID] = @SPClientGroupID) GROUP BY ClientID, CHour   ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("SPClientGroupID", clientGroupID);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetTodayReportByClientID(int clientID)
        {
            string sql = "";

            sql = "SELECT ClientID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord where ClientID = @clientID GROUP BY ClientID, CHour   ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("clientID", clientID);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataTable GetCountReportByClientID(int spClientId, DateTime startDate, DateTime enddate)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("RID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("Price", typeof(decimal)));

            reportDt.AcceptChanges();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForClient(spClientId, startDate.Date, enddate.Date);

            for (DateTime i = startDate; i < enddate.AddDays(1); i = i.AddDays(1))
            {
                j++;

                ReportResult reportResult = GetReportResultByDate(i, dCountReportForMaster);

                reportDt.Rows.Add(j, i.Date,
                                    reportResult.DownCount,
                                    reportResult.DownSycnCount, decimal.Zero);
            }


            return reportDt;
        }

        private ReportResult GetReportResultByDate(DateTime dateTime, DataTable dCountReportForMaster)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now.Date;

            string filterSql = string.Format(" ReportDate='{0}' ", dateTime.Date);

            reportResult.TotalCount = ExecuteSumFormDataTable("UpTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownCount = ExecuteSumFormDataTable("DownTotalCount", filterSql, dCountReportForMaster);
            reportResult.InterceptCount = ExecuteSumFormDataTable("InterceptTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownSycnCount = ExecuteSumFormDataTable("DownSuccess", filterSql, dCountReportForMaster);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;

        }


        private DataTable QueryReportForClient(int clientID, DateTime startDateTime, DateTime enddateTime)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where ReportDate>=@startDate and ReportDate<=@enddate And  clientID = @clientID  ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            dbParameters.AddWithValue("clientID", clientID);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetCountReportByClientGroupID(int spClientGroupId, DateTime startDate, DateTime enddate)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("RID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("Price", typeof(decimal)));

            reportDt.AcceptChanges();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForClientGroup(spClientGroupId, startDate.Date, enddate.Date);

            for (DateTime i = startDate; i < enddate.AddDays(1); i = i.AddDays(1))
            {
                j++;

                ReportResult reportResult = GetReportResultByDate(i, dCountReportForMaster);

                reportDt.Rows.Add(j, i.Date,
                                    reportResult.DownCount,
                                    reportResult.DownSycnCount, decimal.Zero);
            }


            return reportDt;

        }

        private DataTable QueryReportForClientGroup(int spClientGroupId, DateTime startDateTime, DateTime enddateTime)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where ReportDate>=@startDate and ReportDate<=@enddate And  clientID in (SELECT  [ID] FROM  [SPClient] where [SPClientGroupID] = @SPClientGroupID)  ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            dbParameters.AddWithValue("SPClientGroupID", spClientGroupId);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];

        }


        public DataTable CountDataByProvince(int channelID, int clientID, DateTime startDateTime, DateTime enddateTime, string dataType)
        {
            string sql = "select IsNull(Province,'Î´ÖªÊ¡·Ý') as ProvinceName,COUNT(*) as DataCount from SPPaymentInfo where ChannelID = @ChannelID and  ClientID =@ClientID and CreateDate>=@startDate and CreateDate<=@enddate {0} group by Province";

            switch (dataType)
            {
                case "All":
                    sql = string.Format(sql, " ");
                    break;
                case "Intercept":
                    sql = string.Format(sql, " and IsIntercept = 1 ");
                    break;
                case "Down":
                    sql = string.Format(sql, " and IsIntercept = 0 ");
                    break;
                case "DownSycn":
                    sql = string.Format(sql, " and IsIntercept = 0 and SucesssToSend =1 ");
                    break;
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ChannelID", channelID);

            dbParameters.AddWithValue("ClientID", clientID);

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataSet GetGetAllClientChannelIDNeed(DateTime startDate, DateTime endDate)
        {
            string sql = "Select ChannleClientID from dbo.SPPaymentInfo where CreateDate> @startDate and CreateDate < @endDate and IsSycnData = 1 and SucesssToSend = 0 and IsIntercept =0 group by ChannleClientID";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }

        public DayliyReport GetDayReport(int channelID, int clientID, DateTime reportDate)
        {
            if (reportDate.Date == System.DateTime.Now.Date)
            {
                DataTable dsTodayTotalCount = GetTodayTotalCount();
                DataTable dsTodayDownCount = GetTodayDownCount();
                DataTable dsTodayInterceptCount = GetTodayInterceptCount();
                DataTable dsTodayDownSycnCount = GetTodayDownSycnCount();

                ReportResult reportResult = GetTodayReportResult(clientID, channelID, dsTodayTotalCount, dsTodayDownCount, dsTodayInterceptCount, dsTodayDownSycnCount);

                DayliyReport dayliyReport = new DayliyReport();

                dayliyReport.ReportDate = reportDate.Date;

                dayliyReport.SPClientID = clientID;
                dayliyReport.InterceptCount = reportResult.InterceptCount;
                dayliyReport.SycnCount = reportResult.DownSycnCount;
                dayliyReport.DownCount = reportResult.DownCount;
                dayliyReport.TotalCount = reportResult.TotalCount;

                return dayliyReport;
            }
            else
            {
                DataTable dsDaySumReport = GetDaySumReport(reportDate.Date);

                ReportResult reportResult = GetTodayReportResult(clientID, channelID, dsDaySumReport);

                DayliyReport dayliyReport = new DayliyReport();

                dayliyReport.ReportDate = reportDate.Date;

                dayliyReport.SPClientID = clientID;
                dayliyReport.InterceptCount = reportResult.InterceptCount;
                dayliyReport.SycnCount = reportResult.DownSycnCount;
                dayliyReport.DownCount = reportResult.DownCount;
                dayliyReport.TotalCount = reportResult.TotalCount;

                return dayliyReport;

            }


        }

        public DataTable GetClientGroupPriceReport(int clientChannelSettingEntitys, DateTime startDate, DateTime endDate)
        {
            string sql = "Select * from dbo.vw_ClientGroupAmountReport where ReportDate> @startDate and ReportDate < @endDate and  SPClientGroupID = @SPClientGroupID and DownTotalCount>0";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            dbParameters.AddWithValue("SPClientGroupID", clientChannelSettingEntitys);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];  
        }
    }
}