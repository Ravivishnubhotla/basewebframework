// Generated by MyGeneration Version # (1.3.0.9)
using System;
using System.Collections.Generic;
using System.Data;
using System.Text;
using LD.SPPipeManage.Bussiness.Wrappers;
using LD.SPPipeManage.Entity.CustomTyoe;
using LD.SPPipeManage.Entity.Tables;
using Spring.Data.Common;

namespace LD.SPPipeManage.Data.AdoNet
{











    public partial class AdoNetDataObject
    {


 

        public const string DataType_All = "All";
        public const string DataType_Intercept = "Intercept";
        public const string DataType_Down = "Down";
        public const string DataType_DownSycn = "DownSycn";
        public const string DataType_DownNotSycn = "DownNotSycn";
        public const string DataType_SycnFailed = "SycnFailed";

        #region Common

        private T GetScalarFromDataSet<T>(DataTable dt, int columnIndex)
        {
            DataRow dr = GetFristDataRowFromDataTable(dt);

            if (dr != null && dr.Table.Columns.Count >= columnIndex + 1)
                return (T)dr[columnIndex];
            return default(T);
        }

        private T GetScalarFromDataSet<T>(DataSet ds, int columnIndex)
        {
            return GetScalarFromDataSet<T>(GetDataTableFromDataSet(ds), columnIndex);
        }

        private DataRow GetFristDataRowFromDataSet(DataSet ds)
        {
            return GetFristDataRowFromDataTable(GetDataTableFromDataSet(ds));
        }

        private DataRow GetFristDataRowFromDataTable(DataTable dt)
        {
            if (dt != null && dt.Rows.Count > 0)
                return dt.Rows[0];
            return null;
        }

        private DataTable GetDataTableFromDataSet(DataSet ds)
        {
            if (ds != null && ds.Tables.Count > 0)
                return ds.Tables[0];
            return null;
        }

        #endregion


        public string BuildSelectPageSql(string selectField, string tableName, string where, string orderBy, int pageIndex, int pageSize)
        {
            StringBuilder sb = new StringBuilder();

            StringBuilder subquery = new StringBuilder();

            subquery.AppendFormat("SELECT {0},ROW_NUMBER() OVER({1}) AS RowNumber FROM {2} {3} ", selectField, orderBy,
                                  tableName, where);

            int startIndex = (pageIndex - 1) * pageSize + 1;


            sb.AppendFormat(
                "SELECT {0},RowNumber FROM ({1}) AS RowNumberTableSource WHERE  RowNumber BETWEEN {2} AND {3} ", selectField, subquery.ToString(), startIndex, pageIndex * pageSize);


            return sb.ToString();
        }


        public string BuildCountPageSql(string tableName, string where)
        {
            StringBuilder sb = new StringBuilder();

            sb.AppendFormat(" SELECT COUNT(*) FROM {0} {1} ", tableName, where);

            return sb.ToString();
        }


        public DataTable ExcutePageResult(string selectField, string tableName, string where, string orderBy, int pageIndex, int pageSize)
        {
            string sql = BuildSelectPageSql(selectField, tableName, where, orderBy, pageIndex, pageSize);

            return this.ExecuteDataSet(sql, CommandType.Text, this.CreateNewDbParameters()).Tables[0];

        }


        public int ExcuteCount(string tableName, string where)
        {
            string sql = BuildCountPageSql(tableName, where);

            object result = this.ExecuteScalar(sql, CommandType.Text, this.CreateNewDbParameters());

            if (result == System.DBNull.Value)
                return 0;

            return (int)result;
        }

        public DataSet GetAllNOReportData(int year, int month, int day)
        {
            string sql = "Select * from wiew_NoPayReport where CYear = @year and  CMonth =  @month and  CDay=@day";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", year.ToString());

            dbParameters.AddWithValue("month", month.ToString());

            dbParameters.AddWithValue("day", day.ToString());

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }

        public int GetAllRecordCount(DateTime startDate, DateTime endDate, int? channleID, int? clientGroupID, int? channelclientID, string ywid, string cpid, bool hassubcode, string province, string dataType)
        {
            string sql =
                "Select Count(*) from SPPaymentInfo with(nolock) where CreateDate >= @startDate and  CreateDate <  @endDate ";

            sql += BuildFilterSqlByDataType(dataType);

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("endDate", endDate.Date.AddDays(1));

            if (channleID.HasValue)
            {
                sql += " and  ChannleID = @ChannleID ";
                dbParameters.AddWithValue("ChannleID", channleID);
            }

            if (clientGroupID.HasValue)
            {
                sql += " and  ClientGroupID = @ClientGroupID ";
                dbParameters.AddWithValue("ClientGroupID", clientGroupID);
            }

            if (channelclientID.HasValue)
            {
                sql += " and  ChannleClientID = @ChannleClientID ";
                dbParameters.AddWithValue("ChannleClientID", channelclientID);
            }

 

            if (!string.IsNullOrEmpty(ywid))
            {
                if(hassubcode)
                    sql += " and  ywid like '" + ywid + "%' ";
                else
                {
                    sql += " and  ywid = @ywid ";
                    dbParameters.AddWithValue("ywid", ywid);
                }
            }

            if (!string.IsNullOrEmpty(cpid))
            {
                sql += " and  cpid = @cpid ";
                dbParameters.AddWithValue("cpid", cpid);
            }

            if (!string.IsNullOrEmpty(province))
            {
                sql += " and  province = @province ";
                dbParameters.AddWithValue("province", cpid);
            }

            
 

            return this.ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }

        public int GetPhoneCount(DateTime startDate, DateTime endDate, int? channleID, int? clientGroupID, int? channelclientID, string ywid, string cpid, bool hassubcode, string province, string dataType)
        {

            string sql =
                "Select Count(*) from ( Select distinct MobileNumber from SPPaymentInfo with(nolock) where CreateDate >= @startDate and  CreateDate <  @endDate ";

            sql += BuildFilterSqlByDataType(dataType);

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("endDate", endDate.Date.AddDays(1));

            if(channleID.HasValue)
            {
                sql += " and  ChannleID = @ChannleID ";
                dbParameters.AddWithValue("ChannleID", channleID);
            }

            if (clientGroupID.HasValue)
            {
                sql += " and  ClientGroupID = @ClientGroupID ";
                dbParameters.AddWithValue("ClientGroupID", clientGroupID);
            }

            if (channelclientID.HasValue)
            {
                sql += " and  ChannleClientID = @ChannleClientID ";
                dbParameters.AddWithValue("ChannleClientID", channelclientID);
            }

            if (!string.IsNullOrEmpty(ywid))
            {
                if (hassubcode)
                    sql += " and  ywid like '" + ywid + "%' ";
                else
                {
                    sql += " and  ywid = @ywid ";
                    dbParameters.AddWithValue("ywid", ywid);
                }
            }

            if (!string.IsNullOrEmpty(cpid))
            {
                sql += " and  cpid = @cpid ";
                dbParameters.AddWithValue("cpid", cpid);
            }

            if (!string.IsNullOrEmpty(province))
            {
                sql += " and  province = @province ";
                dbParameters.AddWithValue("province", cpid);
            }

            sql += " )   as PC ";

            return this.ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }

        public int FindAllPaymentCountByDateAndType(DateTime startDate, DateTime endDate, int channleClientID, string dataType)
        {

            string sql = "Select Count(*) from SPPaymentInfo with(nolock) where CreateDate >= @startDate and  CreateDate <  @endDate and  ChannleClientID = @ChannleClientID ";

            sql += BuildFilterSqlByDataType(dataType);




            //switch (dataType)
            //{
            //    case "All":
            //        break;
            //    case "Intercept":
            //        sql += " AND IsIntercept = 1 ";
            //        break;
            //    case "Down":
            //        sql += " AND IsIntercept = 0 ";
            //        break;
            //    case "DownSycn":
            //        sql += " AND IsIntercept = 0 AND SucesssToSend = 1 ";
            //        break;
            //    case "DownNotSycn":
            //        sql += " AND IsIntercept = 0 AND IsSycnData = 0 ";
            //        break;
            //    case "SycnFailed":
            //        sql += " AND IsIntercept = 0 AND SucesssToSend = 0 AND IsSycnData=1 AND SycnRetryTimes >0  ";
            //        break;
            //}


            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("endDate", endDate.Date.AddDays(1));

            dbParameters.AddWithValue("ChannleClientID", channleClientID);

            return this.ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }

        public DataSet FindAllPaymentIDByDateAndType(DateTime startDate, DateTime endDate, int channleClientID, string dataType, int limit)
        {
            string top = "";

            if (limit != int.MaxValue)
            {
                top = " TOP " + limit.ToString();
            }


            string sql = "Select " + top + " ID from SPPaymentInfo with(nolock) where CreateDate >= @startDate and  CreateDate <  @endDate and  ChannleClientID = @ChannleClientID ";

            sql += BuildFilterSqlByDataType(dataType);

            //switch (dataType)
            //{
            //    case "All":
            //        break;
            //    case "Intercept":
            //        sql += " AND IsIntercept = 1 ";
            //        break;
            //    case "Down":
            //        sql += " AND IsIntercept = 0 ";
            //        break;
            //    case "DownSycn":
            //        sql += " AND IsIntercept = 0 AND SucesssToSend = 1 ";
            //        break;
            //    case "DownNotSycn":
            //        sql += " AND IsIntercept = 0 AND IsSycnData = 0 ";
            //        break;
            //    case "SycnFailed":
            //        sql += " AND IsIntercept = 0 AND SucesssToSend = 0 AND IsSycnData=1 AND SycnRetryTimes >0  ";
            //        break;
            //}


            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("endDate", endDate.Date.AddDays(1));

            dbParameters.AddWithValue("ChannleClientID", channleClientID);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }


        public void ClearAllReportedData(DateTime date)
        {
            string sql = "update SPPaymentInfo set  IsReport = 1  where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and  IsReport = 0";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }


        public void ResetAllReportedData(DateTime date)
        {
            string sql = "update SPPaymentInfo set  IsReport = 0  where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and  (IsReport = 1 or IsReport is null)";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }


        public DataSet GetAllClientChannel(DateTime reportdate)
        {
            string sql = "SELECT     ChannelID, ClientID FROM  dbo.SPPaymentInfo WITH (nolock) WHERE     (CreateDate > @startDate) AND (CreateDate < @enddate) GROUP BY ChannelID, ClientID";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", reportdate.Date);

            dbParameters.AddWithValue("enddate",reportdate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }


        public string GetDbSize()
        {
            string sql = "exec sp_spaceused";

            DbParameters dbParameters = this.CreateNewDbParameters();

            DataSet ds = this.ExecuteDataSet(sql, CommandType.Text, dbParameters);

            return ds.Tables[0].Rows[0]["database_size"].ToString();
        }


        public void DeleteAllReportData(DateTime date)
        {
            string sql = "delete from SPPaymentInfo where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and IsReport = 1";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }


        public DataSet GetAllNeedSendChannelClient()
        {
            string sql = "SELECT  [ChannelID],[ClinetID] FROM  [dbo].[SPClientChannelSetting] where [SyncData] = 1 group by [ChannelID],[ClinetID]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }


        public DataSet GetAllReportData(DateTime date)
        {
            string sql = "Select * from SPPaymentInfo where Year(CreateDate) = @year and  Month(CreateDate) =  @month and  Day(CreateDate)=@day and IsReport = 1";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year.ToString());

            dbParameters.AddWithValue("month", date.Month.ToString());

            dbParameters.AddWithValue("day", date.Day.ToString());

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }

        public DataTable GetDayliyReport(DateTime date)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ChannelID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ClientID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));


            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dsDaySumReport = GetDaySumReport(date.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                j++;

                ReportResult reportResult = GetTodayReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], dsDaySumReport);

                reportDt.Rows.Add(j,
                                  rowChannelClient["ChannelName"],
                                  rowChannelClient["ClientName"],
                                  reportResult.TotalCount,
                                  reportResult.DownCount,
                                  reportResult.InterceptCount,
                                  reportResult.DownSycnCount,
                                  reportResult.InterceptRate,
                                  (int)rowChannelClient["ChannelID"],
                                  (int)rowChannelClient["ClientID"],
                                  date);
            }

            return reportDt;
        }

        private ReportResult GetTodayReportResult(int clientId, int channelId, DataTable dsDaySumReport)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ClientID = {0} and ChannelID = {1} ", clientId, channelId);

            DataRow[] drs = dsDaySumReport.Select(filterSql);

            reportResult.TotalCount = ExecuteScalarFormDataRowArray("UpTotalCount", drs);
            reportResult.DownCount = ExecuteScalarFormDataRowArray("DownTotalCount", drs);
            reportResult.InterceptCount = ExecuteScalarFormDataRowArray("InterceptTotalCount", drs);
            reportResult.DownSycnCount = ExecuteScalarFormDataRowArray("DownSuccess", drs);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }

        public int ExecuteScalarFormDataRowArray(string field, DataRow[] drs)
        {
            if (drs.Length <= 0)
                return 0;

            if (drs[0][field] == System.DBNull.Value)
                return 0;

            return (int)drs[0][field];
        }

        private DataTable GetDaySumReport(DateTime date)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where Year = @year and  Month =  @month and  Day=@day";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetTodayReport(int clientId, int channelId)
        {
            string sql = "";

            if (channelId != 0)
            {
                sql = "SELECT ClientID, ChannelID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord Where (ChannelID = @ChannelID) AND (ClientID = @ClientID) GROUP BY ClientID, ChannelID, CHour  ";
            }
            else
            {
                sql = "SELECT ClientID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord where ClientID =  @ClientID GROUP BY ClientID, ChannelID, CHour   ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ClientID", clientId);

            if (channelId != 0)
            {
                dbParameters.AddWithValue("ChannelID", channelId);
            }

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }



        public DataTable GetDayliyReport(int channelId, int clientId, DateTime startDateTime, DateTime enddateTime)
        {

            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("RID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("Price", typeof(decimal)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForMaster(channelId, clientId, startDateTime.Date, enddateTime.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                if (channelId > 0)
                {
                    if ((int)rowChannelClient["ChannelID"] != channelId)
                        continue;
                }
                if (clientId > 0)
                {
                    if ((int)rowChannelClient["ClientID"] != clientId)
                        continue;
                }

                for (DateTime i = startDateTime; i < enddateTime.AddDays(1); i = i.AddDays(1))
                {
                    j++;

                    ReportResult reportResult = GetReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], i, dCountReportForMaster);

                    reportDt.Rows.Add(j, i.Date,
                                      rowChannelClient["ChannelName"],
                                      reportResult.DownCount,
                                      reportResult.DownSycnCount, decimal.Zero);
                }
            }

            return reportDt;













            //int j = 0;

            //for (DateTime i = startDateTime; i < enddateTime.AddDays(1); i = i.AddDays(1))
            //{
            //    string sql = "";

            //    if (channelId != 0)
            //    {
            //        sql = "SELECT  ClientID,ChannelID,Sum(UpTotalCount) as TotalCount,Sum(InterceptSuccess) as InterceptCount,Sum(DownSuccess) as DownTotal FROM [dbo].[view_ReportDayTotal] where Year = @year and  Month =  @month and  Day=@day and ClientID = @ClientID and ChannelID=@ChannelID group by  ClientID,ChannelID";
            //    }
            //    else
            //    {
            //        sql = "SELECT  ClientID,Sum(UpTotalCount) as TotalCount,Sum(InterceptSuccess) as InterceptCount,Sum(DownSuccess) as DownTotal FROM [dbo].[view_ReportDayTotal] where Year = @year and  Month =  @month and  Day=@day and ClientID = @ClientID group by  ClientID";
            //    }

            //    DbParameters dbParameters = this.CreateNewDbParameters();

            //    dbParameters.AddWithValue("year", i.Year);

            //    dbParameters.AddWithValue("month", i.Month);

            //    dbParameters.AddWithValue("day", i.Day);

            //    dbParameters.AddWithValue("ClientID", clientId);

            //    if (channelId != 0)
            //    {
            //        dbParameters.AddWithValue("ChannelID", channelId);
            //    }

            //    DataTable dt = this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];

            //    j++;

            //    if(dt==null|| dt.Rows.Count==0)
            //    {
            //        reportDt.Rows.Add(j,i, 0, 0);
            //    }
            //    else
            //    {
            //        reportDt.Rows.Add(j, i, dt.Rows[0]["DownTotal"], 0);      
            //    }
            //}

            return reportDt;
        }

        public ReportResult GetDayReportResult(int clientID, int channelID, DataTable dsDayTotalCount, DataTable dsDayDownCount, DataTable dsDayInterceptCount, DataTable dsDayDownSycnCount)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ClientID = {0} and ChannelID = {1} ", clientID, channelID);

            reportResult.TotalCount = ExecuteScalarFormDataTable("TotalCount", filterSql, dsDayTotalCount);
            reportResult.DownCount = ExecuteScalarFormDataTable("DownCount", filterSql, dsDayDownCount);
            reportResult.InterceptCount = ExecuteScalarFormDataTable("InterceptCount", filterSql, dsDayInterceptCount);
            reportResult.DownSycnCount = ExecuteScalarFormDataTable("DownSycnCount", filterSql, dsDayDownSycnCount);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }


        public DataTable GetDayTotalCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllTotalCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetDayDownCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllDownCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetDayInterceptCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllInterceptCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetDayDownSycnCount(DateTime date)
        {
            string sql = "SELECT * from view_PaymentReportAllDownSycnCount where CYear = @year and  CMonth =  @month and  CDay=@day ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("year", date.Year);

            dbParameters.AddWithValue("month", date.Month);

            dbParameters.AddWithValue("day", date.Day);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }





        #region TodayReport

        public DataTable GetAllTodayReport(bool filterZeroCountChannel)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ChannelClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ChannelID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ClientID", typeof(int)));
            reportDt.Columns.Add(new DataColumn("ChannelClientID", typeof(int)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = null;

            if (filterZeroCountChannel)
                dtChannelClient = GetAllTodayChannelClient();
            else
                dtChannelClient = GetAllChannelClient();

            int j = 0;

            DataTable dsTodayTotalCount = GetTodayTotalCount();
            DataTable dsTodayDownCount = GetTodayDownCount();
            DataTable dsTodayInterceptCount = GetTodayInterceptCount();
            DataTable dsTodayDownSycnCount = GetTodayDownSycnCount();

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                j++;

                ReportResult reportResult = GetTodayReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], dsTodayTotalCount, dsTodayDownCount, dsTodayInterceptCount, dsTodayDownSycnCount);

                reportDt.Rows.Add(j, System.DateTime.Now.Date,
                                  rowChannelClient["ChannelName"],
                                  rowChannelClient["ClientName"],
                                  rowChannelClient["ChannelName"] + " - " + rowChannelClient["ClientName"],
                                  reportResult.TotalCount,
                                  reportResult.DownCount,
                                  reportResult.InterceptCount,
                                  reportResult.DownSycnCount,
                                  reportResult.InterceptRate,
                                  (int)rowChannelClient["ChannelID"],
                                  (int)rowChannelClient["ClientID"], System.DBNull.Value);
            }

            return reportDt;
        }

        private ReportResult GetTodayReportResult(int clientID, int channelID, DataTable dsTodayTotalCount, DataTable dsTodayDownCount, DataTable dsTodayInterceptCount, DataTable dsTodayDownSycnCount)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ClientID = {0} and ChannelID = {1} ", clientID, channelID);

            reportResult.TotalCount = ExecuteScalarFormDataTable("TotalCount", filterSql, dsTodayTotalCount);
            reportResult.DownCount = ExecuteScalarFormDataTable("DownCount", filterSql, dsTodayDownCount);
            reportResult.InterceptCount = ExecuteScalarFormDataTable("InterceptCount", filterSql, dsTodayInterceptCount);
            reportResult.DownSycnCount = ExecuteScalarFormDataTable("DownSycnCount", filterSql, dsTodayDownSycnCount);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }

        private DataTable GetTodayTotalCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayTotalCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        private DataTable GetTodayDownCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayDownCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        private DataTable GetTodayInterceptCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayInterceptCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        private DataTable GetTodayDownSycnCount()
        {
            string sql = "SELECT * from view_PaymentReportTodayDownSycnCount ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        #endregion



        public DataTable GetAllChannelClient()
        {
            string sql = "SELECT * FROM [view_AllClientChannel]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataTable GetAllTodayChannelClient()
        {
            string sql = @"SELECT * FROM [view_AllTodayClientChannleInfo]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }













        public DataTable GetAllEnableChannelClient()
        {
            string sql = "SELECT * FROM [view_PaymentReportClientChannel]";

            DbParameters dbParameters = this.CreateNewDbParameters();

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }



        public decimal CountInterceptRate(int clientID, int channelID)
        {
            string procName = "CountInterceptRate";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ClientID", clientID);

            dbParameters.AddWithValue("ChannelID", channelID);

            dbParameters.AddReturn("returnvalue", DbType.Int32);


            int interceptRate = 0;

            this.ExecuteNoQuery(procName, CommandType.StoredProcedure, dbParameters);

            object result = dbParameters["@returnvalue"].Value;

            if (result != System.DBNull.Value)
            {
                interceptRate = (int)result;
            }

            return Convert.ToDecimal(interceptRate) / 100;
        }


        public int ExecuteScalarFormDataTable(string scalarField, string filterExpress, DataTable dt)
        {
            DataRow[] selectDrs = dt.Select(filterExpress);

            if (selectDrs.Length > 0)
            {
                object result = selectDrs[0][scalarField];

                if (result == System.DBNull.Value)
                {
                    return 0;
                }
                else
                {
                    return (int)result;
                }
            }

            return 0;
        }


        public DataTable GetCountReportForMaster(int channelId, int clientId, DateTime startDateTime, DateTime enddateTime)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForMaster(channelId, clientId, startDateTime.Date, enddateTime.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                if (channelId > 0)
                {
                    if ((int)rowChannelClient["ChannelID"] != channelId)
                        continue;
                }
                if (clientId > 0)
                {
                    if ((int)rowChannelClient["ClientID"] != clientId)
                        continue;
                }

                for (DateTime i = startDateTime; i < enddateTime.AddDays(1); i = i.AddDays(1))
                {
                    j++;

                    ReportResult reportResult = GetReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], i, dCountReportForMaster);

                    reportDt.Rows.Add(j,
                                      rowChannelClient["ChannelName"],
                                      rowChannelClient["ClientName"],
                                      reportResult.TotalCount,
                                      reportResult.DownCount,
                                      reportResult.InterceptCount,
                                      reportResult.DownSycnCount,
                                      reportResult.InterceptRate, i.Date);
                }
            }

            return reportDt;
        }

        public DataTable GetCountReportForMaster(int channelId, DateTime startDateTime, DateTime enddateTime)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("ReportID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ChannelName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("ClientName", typeof(string)));
            reportDt.Columns.Add(new DataColumn("TotalCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("InterceptRate", typeof(decimal)));
            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));

            reportDt.AcceptChanges();

            DataTable dtChannelClient = GetAllEnableChannelClient();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForMaster(channelId, 0, startDateTime.Date, enddateTime.Date);

            foreach (DataRow rowChannelClient in dtChannelClient.Rows)
            {
                if (channelId > 0)
                {
                    if ((int)rowChannelClient["ChannelID"] != channelId)
                        continue;
                }


                for (DateTime i = enddateTime.Date; i > startDateTime.AddDays(-1); i = i.AddDays(-1))
                {
                    j++;

                    ReportResult reportResult = GetReportResult((int)rowChannelClient["ClientID"], (int)rowChannelClient["ChannelID"], i, dCountReportForMaster);

                    reportDt.Rows.Add(j,
                                      rowChannelClient["ChannelName"],
                                      rowChannelClient["ClientName"],
                                      reportResult.TotalCount,
                                      reportResult.DownCount,
                                      reportResult.InterceptCount,
                                      reportResult.DownSycnCount,
                                      reportResult.InterceptRate, i.Date);
                }
            }

            return reportDt;
        }

        private ReportResult GetReportResult(int clientID, int channelID, DateTime dateTime, DataTable dCountReportForMaster)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now;

            string filterSql = string.Format(" ReportDate='{0}' ", dateTime);

            if (channelID > 0)
            {
                filterSql += string.Format(" And  channelId = {0} ", channelID);
            }

            if (clientID > 0)
            {
                filterSql += string.Format(" And  clientID = {0} ", clientID);
            }

            reportResult.TotalCount = ExecuteSumFormDataTable("UpTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownCount = ExecuteSumFormDataTable("DownTotalCount", filterSql, dCountReportForMaster);
            reportResult.InterceptCount = ExecuteSumFormDataTable("InterceptTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownSycnCount = ExecuteSumFormDataTable("DownSuccess", filterSql, dCountReportForMaster);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;
        }

        private int ExecuteSumFormDataTable(string field, string filterSql, DataTable dCountReportForMaster)
        {
            object result = dCountReportForMaster.Compute(string.Format(" SUM({0}) ", field), filterSql);

            if (result == System.DBNull.Value)
            {
                return 0;
            }
            else
            {
                return Convert.ToInt32(result);
            }

            return 0;
        }

        private DataTable QueryReportForMaster(int channelId, int clientID, DateTime startDateTime, DateTime enddateTime)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where ReportDate>=@startDate and ReportDate<=@enddate ";

            if (channelId > 0)
            {
                sql += " And  channelId = @channelId ";
            }

            if (clientID > 0)
            {
                sql += " And  clientID = @clientID ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            if (channelId > 0)
            {
                dbParameters.AddWithValue("channelId", channelId);
            }

            if (clientID > 0)
            {
                dbParameters.AddWithValue("clientID", clientID);
            }

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetTodayReportByClientGroupID(int clientGroupID)
        {
            string sql = "";

            sql = "SELECT ClientID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord where ClientID in (SELECT  [ID] FROM  [SPClient] where [SPClientGroupID] = @SPClientGroupID) GROUP BY ClientID, CHour   ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("SPClientGroupID", clientGroupID);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetTodayReportByClientID(int clientID)
        {
            string sql = "";

            sql = "SELECT ClientID, CHour, COUNT(*) AS Total FROM ClientToDayPaymentRecord where ClientID = @clientID GROUP BY ClientID, CHour   ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("clientID", clientID);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataTable GetCountReportByClientID(int spClientId, DateTime startDate, DateTime enddate)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("RID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("Price", typeof(decimal)));

            reportDt.AcceptChanges();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForClient(spClientId, startDate.Date, enddate.Date);

            for (DateTime i = startDate; i < enddate.AddDays(1); i = i.AddDays(1))
            {
                j++;

                ReportResult reportResult = GetReportResultByDate(i, dCountReportForMaster);

                reportDt.Rows.Add(j, i.Date,
                                    reportResult.DownCount,
                                    reportResult.DownSycnCount, decimal.Zero);
            }


            return reportDt;
        }

        private ReportResult GetReportResultByDate(DateTime dateTime, DataTable dCountReportForMaster)
        {
            ReportResult reportResult = new ReportResult();

            reportResult.ReportDate = DateTime.Now.Date;

            string filterSql = string.Format(" ReportDate='{0}' ", dateTime.Date);

            reportResult.TotalCount = ExecuteSumFormDataTable("UpTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownCount = ExecuteSumFormDataTable("DownTotalCount", filterSql, dCountReportForMaster);
            reportResult.InterceptCount = ExecuteSumFormDataTable("InterceptTotalCount", filterSql, dCountReportForMaster);
            reportResult.DownSycnCount = ExecuteSumFormDataTable("DownSuccess", filterSql, dCountReportForMaster);

            if (reportResult.TotalCount == 0)
                reportResult.InterceptRate = 0;
            else
                reportResult.InterceptRate = (decimal)(reportResult.InterceptCount * 100) / (decimal)(reportResult.TotalCount);


            return reportResult;

        }


        private DataTable QueryReportForClient(int clientID, DateTime startDateTime, DateTime enddateTime)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where ReportDate>=@startDate and ReportDate<=@enddate And  clientID = @clientID  ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            dbParameters.AddWithValue("clientID", clientID);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetCountReportByClientGroupID(int spClientGroupId, DateTime startDate, DateTime enddate)
        {
            DataTable reportDt = new DataTable();


            DataColumn dc = new DataColumn("RID", typeof(int));
            reportDt.Columns.Add(dc);
            reportDt.PrimaryKey = new DataColumn[] { dc };

            reportDt.Columns.Add(new DataColumn("ReportDate", typeof(DateTime)));
            reportDt.Columns.Add(new DataColumn("DownCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("DownSycnCount", typeof(int)));
            reportDt.Columns.Add(new DataColumn("Price", typeof(decimal)));

            reportDt.AcceptChanges();

            int j = 0;

            DataTable dCountReportForMaster = QueryReportForClientGroup(spClientGroupId, startDate.Date, enddate.Date);

            for (DateTime i = startDate; i < enddate.AddDays(1); i = i.AddDays(1))
            {
                j++;

                ReportResult reportResult = GetReportResultByDate(i, dCountReportForMaster);

                reportDt.Rows.Add(j, i.Date,
                                    reportResult.DownCount,
                                    reportResult.DownSycnCount, decimal.Zero);
            }


            return reportDt;

        }

        private DataTable QueryReportForClientGroup(int spClientGroupId, DateTime startDateTime, DateTime enddateTime)
        {
            string sql = "SELECT * from [view_PaymentReportSum] where ReportDate>=@startDate and ReportDate<=@enddate And  clientID in (SELECT  [ID] FROM  [SPClient] where [SPClientGroupID] = @SPClientGroupID)  ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            dbParameters.AddWithValue("SPClientGroupID", spClientGroupId);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];

        }


        public DataTable CountDataByProvince(int channelID, int clientID, DateTime startDateTime, DateTime enddateTime, string dataType)
        {
            string sql = "select IsNull(Province,'') as ProvinceName,COUNT(*) as DataCount from SPPaymentInfo where ChannelID = @ChannelID and  ClientID =@ClientID and CreateDate>=@startDate and CreateDate<=@enddate {0} group by Province";

            switch (dataType)
            {
                case "All":
                    sql = string.Format(sql, " ");
                    break;
                case "Intercept":
                    sql = string.Format(sql, " and IsIntercept = 1 ");
                    break;
                case "Down":
                    sql = string.Format(sql, " and IsIntercept = 0 ");
                    break;
                case "DownSycn":
                    sql = string.Format(sql, " and IsIntercept = 0 and SucesssToSend =1 ");
                    break;
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ChannelID", channelID);

            dbParameters.AddWithValue("ClientID", clientID);

            dbParameters.AddWithValue("startDate", startDateTime.Date);

            dbParameters.AddWithValue("enddate", enddateTime.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataSet GetGetAllClientChannelIDNeed(DateTime startDate, DateTime endDate)
        {
            string sql = "Select ChannleClientID from dbo.SPPaymentInfo where CreateDate> @startDate and CreateDate < @endDate and IsSycnData = 1 and SucesssToSend = 0 and IsIntercept =0 group by ChannleClientID";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters);
        }

        public DayliyReport GetDayReport(int channelID, int clientID, DateTime reportDate)
        {
            if (reportDate.Date == System.DateTime.Now.Date)
            {
                DataTable dsTodayTotalCount = GetTodayTotalCount();
                DataTable dsTodayDownCount = GetTodayDownCount();
                DataTable dsTodayInterceptCount = GetTodayInterceptCount();
                DataTable dsTodayDownSycnCount = GetTodayDownSycnCount();

                ReportResult reportResult = GetTodayReportResult(clientID, channelID, dsTodayTotalCount, dsTodayDownCount, dsTodayInterceptCount, dsTodayDownSycnCount);

                DayliyReport dayliyReport = new DayliyReport();

                dayliyReport.ReportDate = reportDate.Date;

                dayliyReport.SPClientID = clientID;
                dayliyReport.InterceptCount = reportResult.InterceptCount;
                dayliyReport.SycnCount = reportResult.DownSycnCount;
                dayliyReport.DownCount = reportResult.DownCount;
                dayliyReport.TotalCount = reportResult.TotalCount;

                return dayliyReport;
            }
            else
            {
                DataTable dsDaySumReport = GetDaySumReport(reportDate.Date);

                ReportResult reportResult = GetTodayReportResult(clientID, channelID, dsDaySumReport);

                DayliyReport dayliyReport = new DayliyReport();

                dayliyReport.ReportDate = reportDate.Date;

                dayliyReport.SPClientID = clientID;
                dayliyReport.InterceptCount = reportResult.InterceptCount;
                dayliyReport.SycnCount = reportResult.DownSycnCount;
                dayliyReport.DownCount = reportResult.DownCount;
                dayliyReport.TotalCount = reportResult.TotalCount;

                return dayliyReport;

            }


        }

        public DataTable GetClientGroupPriceReport(int clientChannelSettingEntitys, DateTime startDate, DateTime endDate)
        {
            string sql = "SELECT ReportID, ReportDate, UpTotalCount, InterceptTotalCount, DownTotalCount, DownSuccess, ClientID, ChannelID, SPClientGroupID, Price, Amount, ClientAliasName, ClientName FROM vw_ClientGroupAmountReport WHERE (SPClientGroupID = @SPClientGroupID) AND (ReportDate >= @startDate) AND  (ReportDate <@endDate)";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            dbParameters.AddWithValue("SPClientGroupID", clientChannelSettingEntitys);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public void UpdateUrlSuccessSend(int id, string url)
        {
            string sql = "update dbo.SPPaymentInfo set SucesssToSend =1 ,sSycnDataUrl=@sSycnDataUrl where ID=@ID and IsIntercept=0 and IsSycnData=1";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("sSycnDataUrl", url);

            dbParameters.AddWithValue("ID", id);

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }


        public DataTable GetDayCountReportForMaster(DateTime startDate, DateTime endDate)
        {
            string sql = "SELECT * FROM View_DayReport where ReportDate>= @startDate and ReportDate < @endDate";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataTable GetReportDataChange(int reportClientChannleId, DateTime startDate, DateTime endDate)
        {
            string sql = @"SELECT SPDayReport.ReportDate, SPDayReport.UpTotalCount, 
      SPDayReport.InterceptTotalCount, SPDayReport.DownTotalCount, 
      SPDayReport.DownSuccess
FROM SPDayReport INNER JOIN
      SPClientChannelSetting ON 
      SPDayReport.ChannelID = SPClientChannelSetting.ChannelID AND 
      SPDayReport.ClientID = SPClientChannelSetting.ClinetID
WHERE (SPClientChannelSetting.ID = @ReportClientChannleID) AND 
      (SPDayReport.ReportDate >= @StartDate) AND 
      (SPDayReport.ReportDate <= @EndDate)
UNION
SELECT DATEADD(day, 1, @EndDate) AS ReportDate, 
      dbo.GetTodayTotalByClientChannleID(@ReportClientChannleID) AS UpTotalCount, 
      dbo.GetTodayInterceptByClientChannleID(@ReportClientChannleID) 
      AS InterceptTotalCount, 
      dbo.GetTodayDownByClientChannleID(@ReportClientChannleID) AS DownTotalCount, 
      dbo.GetTodayDownSycnByClientChannleID(@ReportClientChannleID) 
      AS DownSuccess";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ReportClientChannleID", reportClientChannleId);

            dbParameters.AddWithValue("StartDate", startDate.Date);

            dbParameters.AddWithValue("EndDate", endDate.Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataTable GetAllPhoneAreaData()
        {
            string sql = @"SELECT  * from  SPPhoneArea";

            DbParameters dbParameters = this.CreateNewDbParameters();
            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public void ResetAllSycnCount(int clientChannelid, DateTime date)
        {
            string sql = "update SPPaymentInfo set  SycnRetryTimes=0 where ChannleClientID = @ChannleClientID and CreateDate>@startDate and CreateDate < @endDate and IsIntercept = 0 and SucesssToSend = 0   and IsSycnData=1   ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ChannleClientID", clientChannelid);

            dbParameters.AddWithValue("startDate", date.Date);

            dbParameters.AddWithValue("enddate", date.AddDays(1).Date);

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }

        public int GetSycnFailedCount(int clientChannelid, DateTime date)
        {
            string sql = "select Count(*) from dbo.SPPaymentInfo where ChannleClientID = @ChannleClientID and CreateDate>@startDate and CreateDate < @endDate and IsIntercept = 0 and SucesssToSend = 0   and IsSycnData=1";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ChannleClientID", clientChannelid);

            dbParameters.AddWithValue("startDate", date.Date);

            dbParameters.AddWithValue("enddate", date.AddDays(1).Date);

            return (int)this.ExecuteScalar(sql, CommandType.Text, dbParameters);
        }


        public void ResetIntercept(int clientChannelid, DateTime date, int dataCount)
        {
            string sql = "update SPPaymentInfo set  IsSycnData=1,IsIntercept = 0 where id in (select Top " + dataCount.ToString() + " id from SPPaymentInfo  where ChannleClientID = @ChannleClientID and CreateDate>@startDate and CreateDate < @endDate and IsIntercept = 1 order by CreateDate asc )   ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ChannleClientID", clientChannelid);

            dbParameters.AddWithValue("startDate", date.Date);

            dbParameters.AddWithValue("enddate", date.AddDays(1).Date);

            this.ExecuteNoQuery(sql, CommandType.Text, dbParameters);
        }


        public DataTable GetClientMobileCount(int spClientId, DateTime startDate, DateTime endDate)
        {
            string sql = "select * from ( Select MobileNumber,Count(*) as RecordCount from SPPaymentInfo with(nolock) where  ClientID =@ClientID and IsIntercept = 0  and createDate >= @startDate and createDate<@enddate group by MobileNumber) as T order by RecordCount desc  ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("ClientID", spClientId);

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetALlClientGroupPriceReport(DateTime startDate, DateTime endDate)
        {
            string sql = "SELECT   vw_ClientGroupAmountReport.ReportID, vw_ClientGroupAmountReport.ReportDate, vw_ClientGroupAmountReport.UpTotalCount, vw_ClientGroupAmountReport.InterceptTotalCount,  vw_ClientGroupAmountReport.DownTotalCount, vw_ClientGroupAmountReport.DownSuccess,  vw_ClientGroupAmountReport.ClientID, vw_ClientGroupAmountReport.ChannelID,   vw_ClientGroupAmountReport.SPClientGroupID, vw_ClientGroupAmountReport.Price,    vw_ClientGroupAmountReport.Amount, vw_ClientGroupAmountReport.ClientAliasName,  vw_ClientGroupAmountReport.ClientName, ISNULL(SPClientGroup.Name, '') AS GroupName FROM  vw_ClientGroupAmountReport LEFT OUTER JOIN SPClientGroup ON vw_ClientGroupAmountReport.SPClientGroupID = SPClientGroup.ID WHERE 1=1 AND (ReportDate >= @startDate) AND  (ReportDate <@endDate)";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetProvinceReport(DateTime startDate, DateTime endDate, int channelId, int channleClientID, bool? isIntercept)
        {
            string sql = @"SELECT [ChannelID] ,[ChannleClientID] ,[Province],COUNT(*) as RecordCount FROM  [dbo].[SPPaymentInfo] with(nolock)
                           WHERE 1=1 AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            if(channelId>0)
            {
                sql += " AND ( [ChannelID] = @channelID) ";
            }

            if (channleClientID > 0)
            {
                sql += " AND ( [ChannleClientID] = @channleClientID) ";
            }

            if(isIntercept!=null)
            {
                sql += " AND ( [IsIntercept] = @IsIntercept) ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            if (channelId > 0)
            {
                dbParameters.AddWithValue("channelID", channelId);
            }

            if (channleClientID > 0)
            {
                dbParameters.AddWithValue("channleClientID", channleClientID);
            }

            if (isIntercept != null)
            {
                dbParameters.AddWithValue("IsIntercept", isIntercept.Value);
            }


            sql += " GROUP BY  [ChannelID] ,[ChannleClientID],[Province] ";

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetProvinceCityReport(DateTime startDate, DateTime endDate, int channelId, int channleClientID,string province, bool? isIntercept)
        {
            string sql = @"SELECT City,COUNT(*) as CityCount FROM  [dbo].[SPPaymentInfo] with(nolock)
                           WHERE 1=1 AND (CreateDate >= @startDate) AND (CreateDate <@endDate) ";

            if (channelId > 0)
            {
                sql += " AND ( [ChannelID] = @channelID) ";
            }

            if (channleClientID > 0)
            {
                sql += " AND ( [ChannleClientID] = @channleClientID) ";
            }

            if (!string.IsNullOrEmpty(province))
            {
                sql += " AND ( [Province] = @Province) ";
            }

            if (isIntercept != null)
            {
                sql += " AND ( [IsIntercept] = @IsIntercept) ";
            }

            sql += " GROUP BY  [City] ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            if (channelId > 0)
            {
                dbParameters.AddWithValue("channelID", channelId);
            }

            if (channleClientID > 0)
            {
                dbParameters.AddWithValue("channleClientID", channleClientID);
            }

            if (!string.IsNullOrEmpty(province))
            {
                dbParameters.AddWithValue("Province", province);
            }

            if (isIntercept != null)
            {
                dbParameters.AddWithValue("IsIntercept", isIntercept.Value);
            }

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetProvinceReportForClientGroup(DateTime startDate, DateTime endDate, int clientGroupId, int channleClientId, bool? isIntercept)
        {
            string sql = @"SELECT [ClientGroupID] ,[ChannleClientID] ,[Province],COUNT(*) as RecordCount FROM  [dbo].[SPPaymentInfo] with(nolock)
                           WHERE 1=1 AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            if (clientGroupId > 0)
            {
                sql += " AND ( [ClientGroupID] = @ClientGroupID) ";
            }

            if (channleClientId > 0)
            {
                sql += " AND ( [ChannleClientID] = @channleClientID) ";
            }

            if (isIntercept != null)
            {
                sql += " AND ( [IsIntercept] = @IsIntercept) ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            if (clientGroupId > 0)
            {
                dbParameters.AddWithValue("ClientGroupID", clientGroupId);
            }

            if (channleClientId > 0)
            {
                dbParameters.AddWithValue("channleClientID", channleClientId);
            }

            if (isIntercept != null)
            {
                dbParameters.AddWithValue("IsIntercept", isIntercept.Value);
            }


            sql += " GROUP BY  [ClientGroupID] ,[ChannleClientID],[Province] ";

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetProvinceCityReportForClientGroup(DateTime startDate, DateTime endDate, int clientGroupId, int channleClientID, string province, bool? isIntercept)
        {
            string sql = @"SELECT City,COUNT(*) as CityCount FROM  [dbo].[SPPaymentInfo] with(nolock)
                           WHERE 1=1 AND (CreateDate >= @startDate) AND (CreateDate <@endDate) ";

            if (clientGroupId > 0)
            {
                sql += " AND ( [ClientGroupID] = @ClientGroupID) ";
            }

            if (channleClientID > 0)
            {
                sql += " AND ( [ChannleClientID] = @channleClientID) ";
            }

            if (!string.IsNullOrEmpty(province))
            {
                sql += " AND ( [Province] = @Province) ";
            }

            if (isIntercept != null)
            {
                sql += " AND ( [IsIntercept] = @IsIntercept) ";
            }

            sql += " GROUP BY  [City] ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            if (clientGroupId > 0)
            {
                dbParameters.AddWithValue("ClientGroupID", clientGroupId);
            }

            if (channleClientID > 0)
            {
                dbParameters.AddWithValue("channleClientID", channleClientID);
            }

            if (!string.IsNullOrEmpty(province))
            {
                dbParameters.AddWithValue("Province", province);
            }

            if (isIntercept != null)
            {
                dbParameters.AddWithValue("IsIntercept", isIntercept.Value);
            }

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public DataTable GetOperatorReport(DateTime startDate, DateTime endDate, int channelId, int channleClientID, bool? isIntercept, string mprovince, string moperator)
        {
            string sql = @"select  MobileOperators as Operator,Province,ChannelID,ChannleClientID,COUNT(*) as RecordCount from dbo.SPPaymentInfo with(nolock)
                           WHERE 1=1 AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            if (channelId > 0)
            {
                sql += " AND ( [ChannelID] = @channelID) ";
            }

            if (channleClientID > 0)
            {
                sql += " AND ( [ChannleClientID] = @channleClientID) ";
            }

            if (isIntercept != null)
            {
                sql += " AND ( [IsIntercept] = @IsIntercept) ";
            }

            if (!string.IsNullOrEmpty(mprovince))
            {
                sql += " AND ( [Province] = @Province) ";
            }

            if (!string.IsNullOrEmpty(moperator))
            {
                sql += " AND ( [MobileOperators] = @MobileOperators) ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            if (channelId > 0)
            {
                dbParameters.AddWithValue("channelID", channelId);
            }

            if (channleClientID > 0)
            {
                dbParameters.AddWithValue("channleClientID", channleClientID);
            }

            if (isIntercept != null)
            {
                dbParameters.AddWithValue("IsIntercept", isIntercept.Value);
            }

            if (!string.IsNullOrEmpty(mprovince))
            {
                dbParameters.AddWithValue("Province", mprovince);
            }

            if (!string.IsNullOrEmpty(moperator))
            {
                dbParameters.AddWithValue("MobileOperators", moperator);
            }

            sql += "  group by  MobileOperators,Province,ChannelID,ChannleClientID ";

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }


        public decimal CaculteActualInterceptRate(int channelClientID, DateTime date)
        {
            string sql = "SELECT  IsIntercept,COUNT(*) as RCount FROM [SPPaymentInfo] with(nolock) where CreateDate>@startDate and CreateDate<@endDate and ChannleClientID=@ChannleClientID  group by IsIntercept";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", date.Date);

            dbParameters.AddWithValue("endDate", date.Date.AddDays(1));

            dbParameters.AddWithValue("ChannleClientID", channelClientID);

            DataTable dt = this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];

            object result = dt.Compute("Sum(RCount)", "");

            int totalCount = 0;

            if (result != System.DBNull.Value)
            {
                totalCount = Convert.ToInt32(result);
            }

            int totalInterceptCount = 0;

            object result2 = dt.Compute("Sum(RCount)", " IsIntercept =1 ");

            if (result2 != System.DBNull.Value)
            {
                totalInterceptCount = Convert.ToInt32(result2);
            }

            if (totalCount <= 0)
                return Decimal.Zero;

            return ((decimal)totalInterceptCount / (decimal)totalCount)*100;
        }

        public DataTable GetDayReport(DateTime startDate, DateTime endDate, string dataType)
        {
            string sql = @"select ChannelID,ChannleClientID,ClientGroupID,COUNT(*) as RecordCount  from dbo.SPPaymentInfo with(nolock)
                           WHERE 1=1 AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            sql += BuildFilterSqlByDataType(dataType);

            sql += " GROUP BY  ChannelID,ChannleClientID,ClientGroupID ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        private static string BuildFilterSqlByDataType(string dataType)
        {
            string filterSQL = "";

            switch (dataType)
            {
                case AdoNetDataObject.DataType_All:
                    break;
                case AdoNetDataObject.DataType_Intercept:
                    filterSQL += " AND IsIntercept = 1 ";
                    break;
                case AdoNetDataObject.DataType_Down:
                    filterSQL += " AND IsIntercept = 0 ";
                    break;
                case AdoNetDataObject.DataType_DownSycn:
                    filterSQL += " AND IsIntercept = 0 AND IsSycnData = 1 AND SucesssToSend = 1 ";
                    break;
                case AdoNetDataObject.DataType_SycnFailed:
                    filterSQL += " AND IsIntercept = 0 AND IsSycnData = 1 AND SucesssToSend = 0";
                    break;
                case AdoNetDataObject.DataType_DownNotSycn:
                    filterSQL += " AND IsIntercept = 0 AND IsSycnData = 0 ";
                    break;
            }
            return filterSQL;
        }






        public DataTable QueryHoursReport(DateTime startDate, DateTime endDate, string dataType,int? channelID,int? channelClientID,int? clientGroupID)
        {
            string sql =
                @"SELECT DATEPART ( hour,CreateDate) as Hours,count(*) as DataCount FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE 1=1 AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            sql += BuildFilterSqlByDataType(dataType);
              
            if (channelID.HasValue)
                sql += " and ChannelID =@ChannleID  ";

            if (channelClientID.HasValue)
                sql += " and ChannleClientID =@ChannleClientID  ";

            if (clientGroupID.HasValue)
                sql += " and ClientGroupID =@clientGroupID  ";

            sql += "  group by DATEPART ( hour,CreateDate) ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            if (channelID.HasValue)
                dbParameters.AddWithValue("ChannleID", channelID.Value);

            if (channelClientID.HasValue)
                dbParameters.AddWithValue("ChannleClientID", channelClientID.Value);

            if (clientGroupID.HasValue)
                dbParameters.AddWithValue("clientGroupID", clientGroupID.Value);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetClientGroupDayReport(DateTime startDate, DateTime endDate, int clientGroupId)
        {
            string sql = @"select ChannelID,ChannleClientID,ClientGroupID,COUNT(*) as RecordCount  from dbo.SPPaymentInfo with(nolock)
                           WHERE 1=1 AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            if (clientGroupId>0)
            {
                sql += " AND ClientGroupID = @ClientGroupID ";
            }


            sql += " AND IsIntercept = 0 ";
 
 

            sql += " GROUP BY  ChannelID,ChannleClientID,ClientGroupID ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startDate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);


            if (clientGroupId > 0)
            {
                dbParameters.AddWithValue("ClientGroupID", clientGroupId);
            }

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public DataTable GetClientGroupTotalReport(DateTime startDate, DateTime endDate)
        {
            string sql = @"SELECT dbo.GetClientGroupName1(ClientGroupID) AS ClientGroupName, dbo.GetMoCode(ChannleClientID) AS Mo,dbo.GetSPClientGroupPriceByClientChannel(ChannleClientID,ClientGroupID) as Price, COUNT(*) AS DownCount
FROM SPPaymentInfo
WHERE (CreateDate > @startdate) AND (CreateDate < @enddate) AND 
      (IsIntercept = 0)
GROUP BY ClientGroupID, ChannleClientID
ORDER BY ClientGroupName";
            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", startDate.Date);

            dbParameters.AddWithValue("enddate", endDate.AddDays(1).Date);

            return this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];
        }

        public List<SPDayReportEntity> GetAllClientGroupDayReport(DateTime reportDate, int clientGroupId)
        {
            string sql = @"SELECT  
       [ClientID], SucesssToSend,
       COUNT(*) as DownCount  
  FROM [SPPaymentInfo] with(nolock)
  where (CreateDate > @startdate) AND (CreateDate < @enddate) AND  ClientGroupID =@ClientGroupID and IsIntercept=0 
  group by [ClientID],SucesssToSend
  order by [ClientID],SucesssToSend

";
            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", reportDate.Date);

            dbParameters.AddWithValue("enddate", reportDate.AddDays(1).Date);

            dbParameters.AddWithValue("ClientGroupID", clientGroupId);

            DataTable dt = this.ExecuteDataSet(sql, CommandType.Text, dbParameters).Tables[0];

            List<SPDayReportEntity> dayReports = new List<SPDayReportEntity>();

            List<int> clients = new List<int>();

            foreach (DataRow dr in dt.Rows)
            {
                int cid = (int)dr["ClientID"];

                if(!clients.Contains(cid))
                    clients.Add(cid);
            }


            foreach (int clientid in clients)
            {
                SPDayReportEntity spDayReport = new SPDayReportEntity();
                spDayReport.ClientID = clientid;
                spDayReport.ReportDate = reportDate;
                spDayReport.DownTotalCount = GetIntValueFromDb(dt.Compute("Sum(DownCount)", string.Format(" ClientID = {0} ", clientid)));
                spDayReport.DownSuccess = GetIntValueFromDb(dt.Compute("Sum(DownCount)", string.Format(" ClientID = {0} and SucesssToSend=1 ", clientid)));
                dayReports.Add(spDayReport);
            }

            return dayReports;
        }

        private int GetIntValueFromDb(object obj)
        {
            if (obj == System.DBNull.Value)
                return 0;
            return Convert.ToInt32(obj);
        }

 
 
 

        public int CacultePaymentCount(DateTime dateTime, int clientChannelId)
        {
            string sql = @" SELECT  count(*) as DataCount FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE 1=1  AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) 

and ChannleClientID =@ChannleClientID";
            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", dateTime.Date);

            dbParameters.AddWithValue("enddate", dateTime.AddDays(1).Date);

            dbParameters.AddWithValue("ChannleClientID", clientChannelId);

            return ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }

        public int CaculteDayPhoneCount(DateTime dateTime, int clientChannelId, string mobileNumber)
        {
            string sql = @" SELECT  count(*) as DataCount FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE IsIntercept=1 AND MobileNumber = @MobileNumber AND  (CreateDate >= @startDate) AND  (CreateDate <@endDate) 

and ChannleClientID =@ChannleClientID";
            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", dateTime.Date);

            dbParameters.AddWithValue("enddate", dateTime.AddDays(1).Date);

            dbParameters.AddWithValue("ChannleClientID", clientChannelId);

            dbParameters.AddWithValue("MobileNumber", mobileNumber);

            return ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }

        public int CaculteMonthPhoneCount(DateTime dateTime, int clientChannelId, string mobileNumber)
        {
            string sql = @" SELECT  count(*) as DataCount FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE IsIntercept=1 AND MobileNumber = @MobileNumber AND  (CreateDate >= @startDate) AND  (CreateDate <@endDate) 

and ChannleClientID =@ChannleClientID";
            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", new DateTime(dateTime.Year, dateTime.Month,1));

            dbParameters.AddWithValue("enddate", new DateTime(dateTime.AddMonths(1).Year, dateTime.AddMonths(1).Month, 1));

            dbParameters.AddWithValue("ChannleClientID", clientChannelId);

            dbParameters.AddWithValue("MobileNumber", mobileNumber);

            return ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }



        public int CaculteDataCount(DateTime startTime,DateTime endTime, List<int> clientChannelIds,bool isIntercept)
        {
            string sql = @" SELECT count(*) as DataCount FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE  (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            if(isIntercept)
                sql += " And IsIntercept=0 ";

            if(clientChannelIds.Count>0)
            {
                sql += " and ChannleClientID in ( ";

                for (int i = 0; i < clientChannelIds.Count; i++)
                {
                    if(i == 0)
                    {
                        sql += clientChannelIds[i].ToString();
                    }
                    else
                    {
                       sql += " , " + clientChannelIds[i].ToString();                     
                    }
                }

                sql += " ) ";
            }

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", startTime.Date);

            dbParameters.AddWithValue("enddate", endTime.Date.AddDays(1));

            return ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }

        public int CacultePhoneCount(DateTime startTime,DateTime endTime, List<int> clientChannelIds,bool isIntercept)
        {
            string sql = @" SELECT MobileNumber FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE  (CreateDate >= @startDate) AND  (CreateDate <@endDate) ";

            if(isIntercept)
                sql += " And IsIntercept=0 ";

            if(clientChannelIds.Count>0)
            {
                sql += " and ChannleClientID in ( ";

                for (int i = 0; i < clientChannelIds.Count; i++)
                {
                    if(i == 0)
                    {
                        sql += clientChannelIds[i].ToString();
                    }
                    else
                    {
                       sql += " , " + clientChannelIds[i].ToString();                     
                    }
                }

                sql += " ) ";
            }

            sql += " group by MobileNumber ";

            sql = " select Count(*) from (" + sql + ") as t ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", startTime.Date);

            dbParameters.AddWithValue("enddate", endTime.Date.AddDays(1));

            return ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }


        public int CacultePaymentCount(DateTime dateTime, int clientChannelId, string province)
        {
            string sql = @" SELECT  count(*) as DataCount FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE 1=1  AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) 

and ChannleClientID =@ChannleClientID and Province=@Province";
            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", dateTime.Date);

            dbParameters.AddWithValue("enddate", dateTime.AddDays(1).Date);

            dbParameters.AddWithValue("ChannleClientID", clientChannelId);

            dbParameters.AddWithValue("Province", province);

            return ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }

        public int CacultePaymentCountNotInProvince(DateTime dateTime, int clientChannelId, List<string> notInprovinces)
        {
            string sql = @" SELECT  count(*) as DataCount FROM  [dbo].[SPPaymentInfo] with(nolock)  WHERE 1=1  AND (CreateDate >= @startDate) AND  (CreateDate <@endDate) 

and ChannleClientID =@ChannleClientID ";

            string[] notinprovincesString = notInprovinces.ToArray();

            for (int i = 0; i < notinprovincesString.Length; i++)
            {
                notinprovincesString[i] = "'" + notinprovincesString[i] + "'";
            }


            sql += " and Province not in (" + string.Join(",", notinprovincesString) + ") ";

            DbParameters dbParameters = this.CreateNewDbParameters();

            dbParameters.AddWithValue("startdate", dateTime.Date);

            dbParameters.AddWithValue("enddate", dateTime.AddDays(1).Date);

            dbParameters.AddWithValue("ChannleClientID", clientChannelId);


            return ExecuteScalar<int>(sql, CommandType.Text, dbParameters);
        }
    }
}