// Generated by MyGeneration Version # (1.3.0.9)
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Text;
using Legendigital.Framework.Common.Bussiness.Interfaces;
using Legendigital.Framework.Common.Data.Interfaces;
using Legendigital.Framework.Common.Bussiness.NHibernate;
using LD.SPPipeManage.Data.Tables;
using LD.SPPipeManage.Entity.Tables;
using Legendigital.Framework.Common.Utility;
using Spring.Transaction.Interceptor;


namespace LD.SPPipeManage.Bussiness.ServiceProxys.Tables
{
	public interface ISPDayReportServiceProxy : IBaseSpringNHibernateEntityServiceProxy<SPDayReportEntity>
    {
	    void BulidReport(DateTime date);
    }

    internal partial class SPDayReportServiceProxy : ISPDayReportServiceProxy
    {
        [Transaction(ReadOnly=false)]
        public void BulidReport(DateTime date)
        {
            //Get all need to generate report's channle nad client ID.
            DataSet dsAllClientChannel = this.AdoNetDb.GetAllClientChannel();

            DataSet dsReportDate = this.AdoNetDb.GetAllReportData(date.Year, date.Month, date.Day);

            foreach (DataRow dataRow in dsAllClientChannel.Tables[0].Rows)
            {
                int channelID = (int)dataRow["ChannelID"];
                int clientID = (int)dataRow["ClientID"];

                int upTotalCount = GetUpTotalCount(date, dsReportDate);
                int interceptTotalCount = GetInterceptTotalCount(date, dsReportDate);
                int sendFailedTotalCount = GetSendFailedTotalCount(date, dsReportDate);


                SPDayReportEntity dayReportEntity = this.SelfDataObj.FindReportByChannelIDChannelIDAndDate(channelID, clientID, date);

                bool hasReport = false;


                if (dayReportEntity==null)
                {
                    hasReport = false;
                    dayReportEntity = new SPDayReportEntity();
                }
                else
                {
                    hasReport = true;
                }

                dayReportEntity.ChannelID = channelID;
                dayReportEntity.ClientID = clientID;
                if (hasReport)
                {
                    dayReportEntity.UpTotalCount += upTotalCount;
                    dayReportEntity.UpSuccess += upTotalCount;
                    dayReportEntity.InterceptTotalCount += upTotalCount;
                    dayReportEntity.InterceptSuccess += interceptTotalCount;
                    dayReportEntity.DownTotalCount += (upTotalCount - interceptTotalCount);
                    dayReportEntity.DownSuccess += (upTotalCount - interceptTotalCount-sendFailedTotalCount);
                }
                else
                {
                    dayReportEntity.UpTotalCount = upTotalCount;
                    dayReportEntity.UpSuccess = upTotalCount;
                    dayReportEntity.InterceptTotalCount = upTotalCount;
                    dayReportEntity.InterceptSuccess = interceptTotalCount;
                    dayReportEntity.DownTotalCount = (upTotalCount - interceptTotalCount);
                    dayReportEntity.DownSuccess = (upTotalCount - interceptTotalCount-sendFailedTotalCount);
                }        
                
                dayReportEntity.ReportDate = new DateTime(date.Year, date.Month, date.Day);

                this.SelfDataObj.SaveOrUpdate(dayReportEntity);



            }

            this.AdoNetDb.ClearAllReportedData(date);     
        }


        private int GetUpTotalCount(DateTime date,DataSet dsReportDate)
        {
            object upTotalCountResult = dsReportDate.Tables[0].Compute("Count(*)", string.Format(" [CYear] = {0} and [CYear] = {1} and [CYear] = {2} ", date.Year, date.Month, date.Day));

            if (upTotalCountResult == System.DBNull.Value)
                return 0;

            return Convert.ToInt32(upTotalCountResult);
        }

        private int GetInterceptTotalCount(DateTime date, DataSet dsReportDate)
        {
            object upTotalCountResult = dsReportDate.Tables[0].Compute("Count(*)", string.Format(" [CYear] = {0} and [CYear] = {1} and [CYear] = {2} and [IsIntercept] = 1 ", date.Year, date.Month, date.Day));

            if (upTotalCountResult == System.DBNull.Value)
                return 0;

            return Convert.ToInt32(upTotalCountResult);
        }

        private int GetSendFailedTotalCount(DateTime date, DataSet dsReportDate)
        {
            object upTotalCountResult = dsReportDate.Tables[0].Compute("Count(*)", string.Format(" [CYear] = {0} and [CYear] = {1} and [CYear] = {2} and [IsIntercept] = 0 and [SucesssToSend]=0 ", date.Year, date.Month, date.Day));

            if (upTotalCountResult == System.DBNull.Value)
                return 0;

            return Convert.ToInt32(upTotalCountResult);
        }

        private string GetFileName(string reportOutPutPath, DateTime date)
        {
            int i = 1;

            bool existFileName = false;

            string fileName = "";

            do
            {
                existFileName =
                    File.Exists(Path.Combine(reportOutPutPath, date.ToString("yyyyMMdd") + i.ToString("N3") + ".zip"));

                fileName = Path.Combine(reportOutPutPath, date.ToString("yyyyMMdd") + i.ToString("N3"));

                i++;


            } while (existFileName);

            return fileName;
        }

        private int GetTotalCountFromDataSet(string totalcount, int channelId, int clientId, DataSet ds)
        {
            DataRow[] drs =
                ds.Tables[0].Select(string.Format(" ChannelID = {0} and ClientID ={1} ", channelId.ToString(),
                                                  clientId.ToString()));
            if (drs.Length > 0)
                return (int) drs[0][totalcount];
            else
                return 0;
        }

        private void WriteDataSetToXml(string reportOutPutPath, string fileName, DataSet dsReportDate)
        {
            string filePath = Path.Combine(reportOutPutPath, fileName);

            if (File.Exists(filePath))
                File.Delete(filePath);

            MemoryStream ms = new MemoryStream();

            dsReportDate.WriteXml(ms);

            File.WriteAllBytes(filePath, CompressionUtil.CompressZipFile(ms.ToArray(), Path.GetFileNameWithoutExtension(fileName)+".xml"));
        }
    }
}
