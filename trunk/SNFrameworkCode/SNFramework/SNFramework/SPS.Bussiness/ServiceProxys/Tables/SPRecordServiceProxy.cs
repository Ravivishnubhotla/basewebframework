// Generated by MyGeneration Version # (1.3.0.9)
using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Text;
using Legendigital.Framework.Common.Bussiness.Interfaces;
using Legendigital.Framework.Common.Data.Interfaces;
using Legendigital.Framework.Common.Bussiness.NHibernate;
using SPS.Bussiness.HttpUtils;
using SPS.Data.Tables;
using SPS.Entity.Tables;


namespace SPS.Bussiness.ServiceProxys.Tables
{
	public interface ISPRecordServiceProxy : IBaseSpringNHibernateEntityServiceProxy<SPRecordEntity> ,ISPRecordServiceProxyDesigner
    {
	    void UpdateUrlSuccessSend(int recordId, string url);
	    void UpdateUrlFailedSend(int recordId, string sendUrl, string errorMessage);
        bool InsertPayment(SPRecordEntity record, SPRecordExtendInfoEntity spRecordExtendInfo, out RequestErrorType requestError, out string errorMessage);
	    SPRecordEntity FindByLinkIDAndChannelID(SPChannelEntity channelID, string linkId);
    }

    internal partial class SPRecordServiceProxy : ISPRecordServiceProxy
    {
        public void UpdateUrlSuccessSend(int recordId, string url)
        {
            this.AdoNetDb.UpdateUrlSuccessSend(recordId, url);
        }

        public void UpdateUrlFailedSend(int recordId, string sendUrl, string errorMessage)
        {
            this.AdoNetDb.UpdateUrlFailedSend(recordId, sendUrl, errorMessage);
        }

        public bool InsertPayment(SPRecordEntity record, SPRecordExtendInfoEntity spRecordExtendInfo, out RequestErrorType requestError, out string errorMessage)
        {
            requestError = RequestErrorType.NoError;

            if (this.CheckHasLinkIDAndChannelID(record.ChannelID, record.LinkID))
            {
                requestError = RequestErrorType.RepeatLinkID;

                errorMessage = "";

                return false;
            }

            try
            {
                this.DataObjectsContainerIocID.SPRecordDataObjectInstance.Save(record);
                spRecordExtendInfo.RecordID = record;
                this.DataObjectsContainerIocID.SPRecordExtendInfoDataObjectInstance.Save(spRecordExtendInfo);
                errorMessage = "";
                return true;
            }
            catch (Exception ex)
            {
                Exception innerEx = ex;

                while (innerEx.InnerException != null)
                {
                    innerEx = innerEx.InnerException;
                }

                if (innerEx is SqlException && ((SqlException)innerEx).Number == 2601)
                {
                    requestError = RequestErrorType.RepeatLinkID;
                    errorMessage = "";
                    return false;
                }

                throw ex;
            }
        }

        private bool CheckHasLinkIDAndChannelID(SPChannelEntity channelID, string linkId)
        {
            SPRecordEntity spPaymentInfoEntity = FindByLinkIDAndChannelID(channelID, linkId);

            return (spPaymentInfoEntity != null);
        }

        public SPRecordEntity FindByLinkIDAndChannelID(SPChannelEntity channelID, string linkId)
        {
            return this.DataObjectsContainerIocID.SPRecordDataObjectInstance.FindByLinkIDAndChannelID(channelID, linkId);
        }
    }
}
